<!DOCTYPE html>
<!-- saved from url=(0866)http://www.jamesfenn.com/keys.htm?fundamental=432&right=3&upright=10&size=50&rotation=343.863&instrument=rhodes&enum=true&equivSteps=17&scale=!%20wilcent17.scl%0A!%0A11-limit%2017%20tone%20scale%20by%20Erv%20Wilson%0A!%20Fokblock(%5B64%2F63%2C%2056%2F55%2C%20968%2F945%2C%2036%2F35%5D%2C%20%5B5%2C%206%2C%2011%2C%206%5D)%20%3D%20%0A!%20Fokblock(%5B64%2F63%2C%2056%2F55%2C%2036%2F35%2C%20704%2F675%5D%2C%20%5B5%2C%203%2C%206%2C%2011%5D)%20%3D%0A!%20Fokblock(%5B64%2F63%2C%20968%2F945%2C%2036%2F35%2C%20704%2F675%5D%2C%20%5B5%2C%2013%2C%206%2C%206%5D)%20wakalix%0A17%0A!%0A22%2F21%0A11%2F10%0A9%2F8%0A7%2F6%0A11%2F9%0A5%2F4%0A4%2F3%0A11%2F8%0A22%2F15%0A3%2F2%0A11%2F7%0A44%2F27%0A5%2F3%0A7%2F4%0A11%2F6%0A15%2F8%0A2%2F1&names=R%0A22%2F21%0A11%2F10%0A9%2F8%0A7%2F6%0A11%2F9%0A5%2F4%0A4%2F3%0A11%2F8%0A22%2F15%0A3%2F2%0A11%2F7%0A44%2F27%0A5%2F3%0A7%2F4%0A11%2F6%0A15%2F8 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>11-limit 17 tone scale by Erv Wilson</title>
	
	<meta charset="utf-8"> 
	<meta name="viewport" content="minimal-ui, width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, target-densitydpi=device-dpi">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="author" content="James Fenn">
	
	<link rel="stylesheet" href="normalize.css">
	<link rel="stylesheet" href="skeleton.css">
	
	<style>
		body {
			/*margin: 0;
			padding: 0;
			background-color: #000000;
			color: white;*/
		}
		#fullscreen-setter {
			background: black;
			color: white;
			border-radius: 1em;
			padding: 1em;
			position: absolute;
			top: 50%;
			left: 50%;
			margin-right: -50%;
			transform: translate(-50%, -50%);
			cursor: pointer
		}
		#keyboard {
			position: absolute;
			height: 100%;
			width: 100%;
			top: 50%;
			left: 50%;
			display: none;
		}
		#backButton {
			position: absolute;
			left: 0;
			top: 50%;
			display: none;
			z-index: 100;
		}
		.iosscrollable {
			height: auto;
			-webkit-overflow-scrolling: touch;
		}
	</style>
	
	<script src="QueryData.compressed.js"></script>
</head>

<body style="overflow: scroll;">
	
	<div id="landing-page" class="section" style="display: block;">
		<div class="container">
			<h1>Edit Settings</h1>

			<select id="quicklinks" onchange="javascript:location.href = this.value;">
				<option selected disabled>Tuning\Layout Quick Links</option>
				<optgroup label="Just Intonation">
					<option value="keys.htm?fundamental=440&right=3&upright=10&size=65&rotation=343.863&instrument=rhodes&enum=false&equivSteps=17&piano_colors=false&no_labels=false&scale=!%20wilcent17.scl%0A!%0A11-limit%2017%20tone%20scale%20by%20Erv%20Wilson%0A!%20Fokblock(%5B64%2F63%2C%2056%2F55%2C%20968%2F945%2C%2036%2F35%5D%2C%20%5B5%2C%206%2C%2011%2C%206%5D)%20%3D%20%0A!%20Fokblock(%5B64%2F63%2C%2056%2F55%2C%2036%2F35%2C%20704%2F675%5D%2C%20%5B5%2C%203%2C%206%2C%2011%5D)%20%3D%0A!%20Fokblock(%5B64%2F63%2C%20968%2F945%2C%2036%2F35%2C%20704%2F675%5D%2C%20%5B5%2C%2013%2C%206%2C%206%5D)%20wakalix%0A17%0A!%0A22%2F21%0A11%2F10%0A9%2F8%0A7%2F6%0A11%2F9%0A5%2F4%0A4%2F3%0A11%2F8%0A22%2F15%0A3%2F2%0A11%2F7%0A44%2F27%0A5%2F3%0A7%2F4%0A11%2F6%0A15%2F8%0A2%2F1&names=R%0A22%2F21%0A11%2F10%0A9%2F8%0A7%2F6%0A11%2F9%0A5%2F4%0A4%2F3%0A11%2F8%0A22%2F15%0A3%2F2%0A11%2F7%0A44%2F27%0A5%2F3%0A7%2F4%0A11%2F6%0A15%2F8">Erv Wilson 11 Limit 17 Tone</option>
					
					<option value="keys.htm?fundamental=220&right=7&upright=4&size=55&rotation=343.863&instrument=rhodes&enum=false&equivSteps=43&piano_colors=false&no_labels=false&scale=!%20PARTCH_43.scl%0A!%0AHarry%20Partch%27s%2043-tone%20pure%20scale%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%2043%0A!%0A%2081%2F80%0A%2033%2F32%0A%2021%2F20%0A%2016%2F15%0A%2012%2F11%0A%2011%2F10%0A%2010%2F9%0A%209%2F8%0A%208%2F7%0A%207%2F6%0A%2032%2F27%0A%206%2F5%0A%2011%2F9%0A%205%2F4%0A%2014%2F11%0A%209%2F7%0A%2021%2F16%0A%204%2F3%0A%2027%2F20%0A%2011%2F8%0A%207%2F5%0A%2010%2F7%0A%2016%2F11%0A%2040%2F27%0A%203%2F2%0A%2032%2F21%0A%2014%2F9%0A%2011%2F7%0A%208%2F5%0A%2018%2F11%0A%205%2F3%0A%2027%2F16%0A%2012%2F7%0A%207%2F4%0A%2016%2F9%0A%209%2F5%0A%2020%2F11%0A%2011%2F6%0A%2015%2F8%0A%2040%2F21%0A%2064%2F33%0A%20160%2F81%0A%202%2F1&names=R%20%0A81%2F80%0A%2033%2F32%0A%2021%2F20%0A%2016%2F15%0A%2012%2F11%0A%2011%2F10%0A%2010%2F9%0A%209%2F8%0A%208%2F7%0A%207%2F6%0A%2032%2F27%0A%206%2F5%0A%2011%2F9%0A%205%2F4%0A%2014%2F11%0A%209%2F7%0A%2021%2F16%0A%204%2F3%0A%2027%2F20%0A%2011%2F8%0A%207%2F5%0A%2010%2F7%0A%2016%2F11%0A%2040%2F27%0A%203%2F2%0A%2032%2F21%0A%2014%2F9%0A%2011%2F7%0A%208%2F5%0A%2018%2F11%0A%205%2F3%0A%2027%2F16%0A%2012%2F7%0A%207%2F4%0A%2016%2F9%0A%209%2F5%0A%2020%2F11%0A%2011%2F6%0A%2015%2F8%0A%2040%2F21%0A%2064%2F33%0A%20160%2F81%0A%202%2F1">Harry Partch 43 Janko</option>
				</optgroup>

				<optgroup label="Equal Temperaments">
					<option value="keys.htm?fundamental=440&right=2&upright=1&size=65&rotation=343.863&instrument=rhodes&enum=false&equivSteps=12&piano_colors=true&no_labels=false&scale=100.0%0A200.0%0A300.0%0A400.0%0A500.0%0A600.0%0A700.0%0A800.0%0A900.0%0A1000.0%0A1100.0%0A1200.0&names=A%0ABb%0AB%0AC%0ADb%0AD%0AEb%0AE%0AF%0AGb%0AG%0AAb">12ET Janko</option>
					
					<option value="keys.htm?fundamental=440&right=2&upright=7&size=65&rotation=343.863&instrument=rhodes&enum=false&equivSteps=12&piano_colors=true&no_labels=false&scale=100.0%0A200.0%0A300.0%0A400.0%0A500.0%0A600.0%0A700.0%0A800.0%0A900.0%0A1000.0%0A1100.0%0A1200.0&names=A%0ABb%0AB%0AC%0ADb%0AD%0AEb%0AE%0AF%0AGb%0AG%0AAb">12ET Wicki-Hayden</option>
					
					<option value="keys.htm?fundamental=440&right=3&upright=2&size=70&rotation=343.863&instrument=rhodes&enum=false&equivSteps=19&piano_colors=false&no_labels=false&scale=63.0%0A126.0%0A189.0%0A253.0%0A316.0%0A379.0%0A442.0%0A505.0%0A568.0%0A632.0%0A695.0%0A758.0%0A821.0%0A884.0%0A947.0%0A1011.0%0A1074.0%0A1137.0%0A1200.0&names=A%0AA%E2%99%AF%0AB%E2%99%AD%0AB%0AB%E2%99%AF%2FC%E2%99%AD%0AC%0AC%E2%99%AF%0AD%E2%99%AD%0AD%0AD%E2%99%AF%0AE%E2%99%AD%0AE%0AE%E2%99%AF%2FF%E2%99%AD%0AF%0AF%E2%99%AF%0AG%E2%99%AD%0AG%0AG%E2%99%AF%0AA%E2%99%AD%0AA">19ET Janko</option>

					<option value="keys.htm?fundamental=440&right=5&upright=3&size=65&rotation=343.863&instrument=rhodes&enum=false&equivSteps=31&piano_colors=false&no_labels=false&scale=39.0%0A77.00%0A116.00%0A154.00%0A194.00%0A232.00%0A271.00%0A310.00%0A348.00%0A387.00%0A426.00%0A465.00%0A503.00%0A542.00%0A581.00%0A619.00%0A658.00%0A697.00%0A735.00%0A774.00%0A813.00%0A852.00%0A890.00%0A929.00%0A968.00%0A1006.00%0A1045.00%0A1084.00%0A1123.00%0A1161.00%0A1200.00&names=A%0ABbb%0AA%23%0ABb%0AAx%0AB%0ACb%0AB%23%0AC%0ADbb%0AC%23%0ADb%0ACx%0AD%0AEbb%0AD%23%0AEb%0ADx%0AE%0AFb%0AE%23%0AF%0AGbb%0AF%23%0AGb%0AFx%0AG%0AAbb%0AG%23%0AAb%0AGx">31ET Janko</option>

					<option value="keys.htm?fundamental=440&right=5&upright=18&size=65&rotation=343.863&instrument=rhodes&enum=false&equivSteps=31&piano_colors=false&no_labels=false&scale=39.0%0A77.00%0A116.00%0A154.00%0A194.00%0A232.00%0A271.00%0A310.00%0A348.00%0A387.00%0A426.00%0A465.00%0A503.00%0A542.00%0A581.00%0A619.00%0A658.00%0A697.00%0A735.00%0A774.00%0A813.00%0A852.00%0A890.00%0A929.00%0A968.00%0A1006.00%0A1045.00%0A1084.00%0A1123.00%0A1161.00%0A1200.00&names=A%0ABbb%0AA%23%0ABb%0AAx%0AB%0ACb%0AB%23%0AC%0ADbb%0AC%23%0ADb%0ACx%0AD%0AEbb%0AD%23%0AEb%0ADx%0AE%0AFb%0AE%23%0AF%0AGbb%0AF%23%0AGb%0AFx%0AG%0AAbb%0AG%23%0AAb%0AGx">31ET Wicki-Hayden</option>

					<option value="keys.htm?fundamental=220&right=5&upright=3&size=65&rotation=343.863&instrument=organ&enum=false&equivSteps=31&piano_colors=false&no_labels=false&scale=!%20cet39c.scl%0A!%0A31-tET%2011-limit%20TOP%20tuning%0A%2031%0A!%0A%2038.75702%0A%2077.51403%0A%20116.27105%0A%20155.02807%0A%20193.78509%0A%20232.54210%0A%20271.29912%0A%20310.05614%0A%20348.81315%0A%20387.57017%0A%20426.32719%0A%20465.08421%0A%20503.84122%0A%20542.59824%0A%20581.35526%0A%20620.11227%0A%20658.86929%0A%20697.62631%0A%20736.38333%0A%20775.14034%0A%20813.89736%0A%20852.65438%0A%20891.41139%0A%20930.16841%0A%20968.92543%0A%201007.68245%0A%201046.43946%0A%201085.19648%0A%201123.95350%0A%201162.71051%0A%201201.46753&names=A%0ABbb%0AA%23%0ABb%0AAx%0AB%0ACb%0AB%23%0AC%0ADbb%0AC%23%0ADb%0ACx%0AD%0AEbb%0AD%23%0AEb%0ADx%0AE%0AFb%0AE%23%0AF%0AGbb%0AF%23%0AGb%0AFx%0AG%0AAbb%0AG%23%0AAb%0AGx">31ET 11 Limit TOP Janko</option>

					<option value="keys.htm?fundamental=440&right=9&upright=4&size=55&rotation=343.863&instrument=rhodes&enum=true&equivSteps=53&piano_colors=false&no_labels=false&scale=22.642%0A45.283%0A67.925%0A90.566%0A113.208%0A135.849%0A158.491%0A181.132%0A203.774%0A226.415%0A249.057%0A271.698%0A294.34%0A316.981%0A339.623%0A362.264%0A384.906%0A407.547%0A430.189%0A452.83%0A475.472%0A498.113%0A520.755%0A543.396%0A566.038%0A588.679%0A611.321%0A633.962%0A656.604%0A679.245%0A701.887%0A724.528%0A747.17%0A769.811%0A792.453%0A815.094%0A837.736%0A860.377%0A883.019%0A905.66%0A928.302%0A950.943%0A973.585%0A996.226%0A1018.868%0A1041.509%0A1064.151%0A1086.792%0A1109.434%0A1132.075%0A1154.717%0A1177.358&names=R%0A22.642%0A45.283%0A67.925%0A90.566%0A113.208%0A135.849%0A158.491%0A181.132%0A203.774%0A226.415%0A249.057%0A271.698%0A294.34%0A316.981%0A339.623%0A362.264%0A384.906%0A407.547%0A430.189%0A452.83%0A475.472%0A498.113%0A520.755%0A543.396%0A566.038%0A588.679%0A611.321%0A633.962%0A656.604%0A679.245%0A701.887%0A724.528%0A747.17%0A769.811%0A792.453%0A815.094%0A837.736%0A860.377%0A883.019%0A905.66%0A928.302%0A950.943%0A973.585%0A996.226%0A1018.868%0A1041.509%0A1064.151%0A1086.792%0A1109.434%0A1132.075%0A1154.717%0A1177.358">53ET Janko</option>
				</optgroup>

			</select>


			<form id="settingsForm">
				<div class="row">
					<div class="one-half column">

						<label>Fundamental (Hz)</label>
						<input id="fundamental" type="number" min="20" max="20000" value="440" onchange="changeURL()">
			
						<label>Right Facing Steps</label>
						<input id="rSteps" type="number" min="-1220" max="1220" value="0" onchange="changeURL()">  
				
						<label>Up/Right Facing Steps</label>
						<input id="urSteps" type="number" min="-1220" max="1220" value="0" onchange="changeURL()">   
					</div>
					<div class="one-half column">
						<label>Hex Size (pixels)</label>
						<input id="hexSize" type="number" min="20" max="1000" value="50" onchange="changeURL()"><br>  
			
						<label>Rotation (degrees)</label>
						<input id="rotation" type="number" step="any" min="0" max="360" value="0" onchange="changeURL()"><br>  
			
						<label>Instrument</label>
						<select id="instrument" onchange="changeURL()">
							<option value="piano">Piano</option>
							<option value="harpsichord">Harpsichord</option>
							<option value="rhodes">Rhodes</option>
							<option value="harp">Harp</option>
							<option value="choir">Choir</option>
							<option value="strings">Strings</option>
							<option value="sawtooth">Sawtooth</option>
							<option value="gayageum">Gayageum</option>
							<option value="qanun">Qanun</option>
							<option value="organ">Organ</option>
							<option value="organleslie">Organ + Leslie</option>
						</select>
					</div>
				</div>
				<div class="row">
					<div class="one-half column">
						<img src="1x1.png">
					</div>
					<div class="one-half column">
						<label>
							<input id="enum" type="checkbox" name="number_or_name" value="fnord" onchange="hideRevealNames()">
							<span class="label-body">Enumerate Scale</span>
						</label>

						<label>
							<input id="piano_colors" type="checkbox" name="piano_colors" onchange="hideRevealNames()">
							<span class="label-body">Piano Colors (only 12ET)</span>
						</label>

						<label>
							<input id="no_labels" type="checkbox" name="no_labels" onchange="hideRevealNames()">
							<span class="label-body">Blank Keys (No labels)</span>
						</label>
					</div>
				</div>

				<div class="row">
					<div class="one-half column">
						<label>Scale (scala format)</label>
						<textarea id="scale" onchange="changeURL()" class="iosscrollable u-full-width" rows="12">! wilcent17.scl
!
11-limit 17 tone scale by Erv Wilson
! Fokblock([64/63, 56/55, 968/945, 36/35], [5, 6, 11, 6]) = 
! Fokblock([64/63, 56/55, 36/35, 704/675], [5, 3, 6, 11]) =
! Fokblock([64/63, 968/945, 36/35, 704/675], [5, 13, 6, 6]) wakalix
17
!
22/21
11/10
9/8
7/6
11/9
5/4
4/3
11/8
22/15
3/2
11/7
44/27
5/3
7/4
11/6
15/8
2/1</textarea>
				</div>
				<div class="one-half column">
					<label id="numberLabel" style="display: block;">Steps To Equivalence Interval</label>
					<input id="equivSteps" type="number" min="1" max="200" value="1" onchange="changeURL()" style="display: block;">
			
					<label id="namesLabel" style="display: none;">Note Names</label>
					<textarea id="names" onchange="changeURL()" class="iosscrollable u-full-width" rows="12" style="display: none;">R
22/21
11/10
9/8
7/6
11/9
5/4
4/3
11/8
22/15
3/2
11/7
44/27
5/3
7/4
11/6
15/8</textarea>
					</div>
				</div>
				<br>
				<input name="Submit" type="submit" value="Make me a microtonal keyboard!">
			</form></div>
		
		
		<div id="donate" class="container">
    		<div id="donateText">
				
			</div>
			<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="D5ARRM2XUK5DU">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
		</div>
        
		<div class="container">
		Credit to James Fenn, the original developer and to Scott Thompson and <a href="http://ozanyarman.com/">Dr Ozan Yarman</a> for contributing samples
		</div>
	</div>
	<canvas id="keyboard" tabindex="1" width="1897" height="936" style="display: none; height: 936px; width: 1897px; margin-top: -468px; margin-left: -948.5px;"></canvas>
	
	<img src="back.png" id="backButton" onclick="back()" style="display: none;">
	
	<script>
		// fill in form 
    document.getElementById('settingsForm').onsubmit = goKeyboard;
    
		var getData = new QueryData(location.search, true);
		document.getElementById("fundamental").value = ("fundamental" in getData) ? getData.fundamental : 432;
		document.getElementById("rSteps").value = ("right" in getData) ? getData.right : 3;
		document.getElementById("urSteps").value = ("upright" in getData) ? getData.upright : 10;
		document.getElementById("hexSize").value = ("size" in getData) ? getData.size : 50;
		document.getElementById("rotation").value = ("rotation" in getData) ? getData.rotation : 343.863;
		document.getElementById("instrument").value = ("instrument" in getData) ? getData.instrument : "harp";
		document.getElementById("enum").checked = ("enum" in getData) ? JSON.parse(getData.enum) : false;
		document.getElementById("equivSteps").value = ("equivSteps" in getData) ? getData.equivSteps : 17;
		document.getElementById("piano_colors").checked = ("piano_colors" in getData) ? JSON.parse(getData.piano_colors) : false;
		document.getElementById("no_labels").checked = ("no_labels" in getData) ? JSON.parse(getData.no_labels) : false;
		
		var global_pressed_interval;

		if ("scale" in getData) {
			document.getElementById("scale").value = getData.scale[0];
		}
		
		if ("names" in getData) {
			document.getElementById("names").value = getData.names[0];
		} 
		
		hideRevealNames();
		
		function hideRevealNames() {
			if (document.getElementById("enum").checked) {
				document.getElementById("equivSteps").style.display = 'block';
				document.getElementById("names").style.display = 'none';
				document.getElementById("numberLabel").style.display = 'block';
				document.getElementById("namesLabel").style.display = 'none';
			} else {
				document.getElementById("equivSteps").style.display = 'none';
				document.getElementById("names").style.display = 'block';
				document.getElementById("numberLabel").style.display = 'none';
				document.getElementById("namesLabel").style.display = 'block';
			}
			changeURL();
		}
		
		function Point(x, y) {
			this.x = x;
			this.y = y;
		}
		
		Point.prototype.equals = function(p) {
			return (this.x == p.x && this.y == p.y)
		}
		
		Point.prototype.plus = function(p) {
			var x = this.x + p.x;
			var y = this.y + p.y;
			return (new Point(x, y));
		}
		
		Point.prototype.minus = function(p) {
			var x = this.x - p.x;
			var y = this.y - p.y;
			return (new Point(x, y));
		}
		
		function changeURL() {
			var url = window.location.pathname + "?";
			// add fundamental, right, upright, size
			
			url += "fundamental=" + document.getElementById("fundamental").value
					+ "&right=" + document.getElementById("rSteps").value
					+ "&upright=" + document.getElementById("urSteps").value
					+ "&size=" + document.getElementById("hexSize").value
					+ "&rotation=" + document.getElementById("rotation").value
					+ "&instrument=" + document.getElementById("instrument").value
					+ "&enum=" + document.getElementById("enum").checked
					+ "&equivSteps=" + document.getElementById("equivSteps").value
                    + "&piano_colors=" + document.getElementById("piano_colors").checked
                    + "&no_labels=" + document.getElementById("no_labels").checked;
			
			url += "&scale=";	
			url += encodeURIComponent(document.getElementById('scale').value);
			
			url += "&names=";
			url += encodeURIComponent(document.getElementById('names').value);
			
			// Find scl file description for the page title
			
			var scaleLines = document.getElementById('scale').value.split('\n');
			var first = true;
			var foundDescription = false;
			var description = "I want a terpstra!";
			
			scaleLines.forEach( function(line) {
				if(!(foundDescription) && !(line.match(/^\!/)) && line.match(/[a-zA-Z]+/)) {
					foundDescription = true;
					description = line;
				}
			});
			
			document.title = description;
			
			window.history.replaceState( {} , '', url ); 
		}
		
		var settings = new Object;
	
		function parseScale() {
			settings.scale = new Array;
			var scaleLines = document.getElementById('scale').value.split('\n');
			scaleLines.forEach( function(line) {
				if (line.match(/^[1234567890.\s/]+$/) && !(line.match(/^\s+$/)) ) { 
					if (line.match(/\//)) {
						// ratio
						var nd = line.split('/');
						var ratio = 1200 *  Math.log(parseInt(nd[0]) / parseInt(nd[1])) / Math.log(2);
						settings.scale.push(ratio);
					} else {
						if (line.match(/\./))
						// cents
							settings.scale.push(parseFloat(line));
					}
				}
			});
			settings.equivInterval = settings.scale.pop();
			settings.scale.unshift(0);
		}
				
		function calculateRotationMatrix(rotation, center) {
			var m = new Array;

			m[0] = Math.cos(rotation);
			m[1] = Math.sin(rotation);
			m[2] = -m[1];
			m[3] = m[0];
			m[4] = center.x - m[0] * center.x - m[2] * center.y;		
			m[5] = center.y - m[1] * center.x - m[3] * center.y;
			
			return m;
		}
		
		function applyMatrixToPoint(m, p) { /*Array, Point*/
					return new Point(
						m[0] * p.x + m[2] * p.y + m[4],
						m[1] * p.x + m[3] * p.y + m[5]
					);
		}
		
		function resizeHandler () {
			// Resize Inner and outer coordinates of canvas to preserve aspect ratio
		
			var newWidth = window.innerWidth;
			var newHeight = window.innerHeight;
			
			settings.canvas.style.height = newHeight + 'px';
			settings.canvas.style.width = newWidth + 'px';
    
			settings.canvas.style.marginTop = (-newHeight / 2) + 'px';
			settings.canvas.style.marginLeft = (-newWidth / 2) + 'px';
    
			settings.canvas.width = newWidth;
			settings.canvas.height = newHeight;
			
			// Find new centerpoint
			
			var centerX = newWidth / 2;
			var centerY = newHeight / 2;
			settings.centerpoint = new Point(centerX, centerY);
			
			// Rotate about it

			if (settings.rotationMatrix) { 
				settings.context.restore();
			}
			settings.context.save();
			
			settings.rotationMatrix = calculateRotationMatrix(-settings.rotation, settings.centerpoint);
			
			var m = calculateRotationMatrix(settings.rotation, settings.centerpoint);
			settings.context.setTransform(m[0], m[1], m[2], m[3], m[4], m[5]);
			
			// Redraw Grid
			
			drawGrid();
		}
		
		function back() {
			document.getElementById("keyboard").style.display = "none";
			document.getElementById("backButton").style.display = "none";
			document.getElementById("landing-page").style.display = "block";
			document.body.style.overflow = 'scroll';
		}
		
		function goKeyboard() {
		
			changeURL();
			
			// Set up screen 
			
			document.getElementById("landing-page").style.display = "none";
			document.getElementById("keyboard").style.display = "block";
			document.body.style.overflow = 'hidden';
			document.getElementById("backButton").style.display = "block";
			
			// set up settings constants
			
			settings.fundamental = document.getElementById("fundamental").value;
			settings.rSteps = document.getElementById("rSteps").value;
			settings.urSteps = parseFloat(settings.rSteps) - parseFloat(document.getElementById("urSteps").value); // Adjust to different coordinate system
			settings.hexSize = document.getElementById("hexSize").value;
			settings.rotation = (document.getElementById("rotation").value * 2 * Math.PI) / 360;
			parseScale();
			settings.names = document.getElementById('names').value.split('\n');
			settings.enum = document.getElementById('enum').checked;
			settings.equivSteps = parseInt(document.getElementById('equivSteps').value);
			
			settings.canvas = document.getElementById('keyboard');
			settings.context = settings.canvas.getContext('2d');
			
			settings.hexHeight = settings.hexSize * 2;
			settings.hexVert = settings.hexHeight * 3/4;
			settings.hexWidth = Math.sqrt(3)/2 * settings.hexHeight;

			settings.piano_colors = document.getElementById('piano_colors').checked;
			settings.no_labels = document.getElementById('no_labels').checked;
			
			// Set up resize handler
			
			window.addEventListener('resize', resizeHandler, false);
			window.addEventListener('orientationchange', resizeHandler, false);
			
			//... and give it an initial call
			
			resizeHandler();			
			
			// Set up synth
			
			settings.sampleBuffer = [,,,];
			var instrumentOption = document.getElementById("instrument").selectedIndex;
			var instruments = [
				{ fileName : "piano", fade : 0.1},
				{ fileName : "harpsichord", fade : 0.2},
				{ fileName : "rhodes", fade : 0.1},
				{ fileName : "harp", fade : 0.2},
				{ fileName : "choir", fade : 0.5},
				{ fileName : "strings", fade : 0.9},
				{ fileName : "sawtooth", fade : 0.2},
				{ fileName : "gayageum", fade : 1},
				{ fileName : "qanun", fade : 1},
				{ fileName : "organ", fade : 0.1},
				{ fileName : "organleslie", fade : 0.1}
				
			];
			
			//console.log(instruments[instrumentOption]);
			
			loadSample(instruments[instrumentOption].fileName, 0);
			settings.sampleFadeout = instruments[instrumentOption].fade;
			
			// Set up keyboard, touch and mouse event handlers
			
			settings.sustain = false;
			settings.sustainedNotes = new Array;
			//settings.canvas.addEventListener("keydown", sustainOn, false); // Firefox isn't firing :(
			//settings.canvas.addEventListener("keyup", sustainOff, false);
			
			window.addEventListener("keydown", sustainOn, true);
			window.addEventListener("keyup", sustainOff, false);

			//iPad Shake to toggle sustain
			if (typeof window.DeviceMotionEvent != 'undefined') 
			{
				var lastShakeCheck=0;
				var lastShakeCount=0;

			    // Shake sensitivity (a lower number is more)
			    var sensitivity = 5;

			    // Position variables
			    var x1 = 0, y1 = 0, z1 = 0, x2 = 0, y2 = 0, z2 = 0;

			    // Listen to motion events and update the position
			    window.addEventListener('devicemotion', function (e) {
			        x1 = e.accelerationIncludingGravity.x;
			        y1 = e.accelerationIncludingGravity.y;
			        z1 = e.accelerationIncludingGravity.z;
			    }, false);

			    // Periodically check the position and fire
			    // if the change is greater than the sensitivity
			    setInterval(function () {
			    	lastShakeCheck++;
			        var change = Math.abs(x1-x2+y1-y2+z1-z2);

			        if (change > sensitivity) {

			        	if(lastShakeCheck-lastShakeCount >=3)
			        	{
			        		lastShakeCount=lastShakeCheck;

				            if(settings.sustain == true)
				            {
				            	settings.sustain=false;
				            	for (var note = 0; note < settings.sustainedNotes.length; note++) {
									settings.sustainedNotes[note].noteOff();
								}
								settings.sustainedNotes = new Array;
				            	tempAlert('Sustain Off',900);
				            }
				            else
				            {
				            	settings.sustain=true;
				            	tempAlert('Sustain On',900);
				            }
			        	}
			        }

			        // Update new position
			        x2 = x1;
			        y2 = y1;
			        z2 = z1;
			    }, 300);
			}

			//
			
			settings.activeHexObjects = new Array;
			settings.canvas.addEventListener("touchstart", handleTouch, false);
			settings.canvas.addEventListener("touchend", handleTouch, false);
			settings.canvas.addEventListener("touchmove", handleTouch, false);
			
			settings.canvas.addEventListener("mousedown", function(e) {
				settings.canvas.addEventListener("mousemove", mouseActive, false);
				mouseActive(e);
			}, false);
			
			settings.canvas.addEventListener("mouseup", function(e) {
				settings.canvas.removeEventListener("mousemove", mouseActive);
				var coords = settings.activeHexObjects[0].coords;
				settings.activeHexObjects[0].noteOff();
				drawHex(coords, centsToColor(hexCoordsToCents(coords), false));
				settings.activeHexObjects.pop();
			}, false);
      return false;
		}
		
		function sustainOn (e) {
			//console.log("sustain On");
			if (e.keyCode == 32) {  // Spacebar
				settings.sustain = true;
			}
		}
		
		function sustainOff (e) {
			if (e.keyCode == 32) {  // Spacebar
				settings.sustain = false;
				for (var note = 0; note < settings.sustainedNotes.length; note++) {
					settings.sustainedNotes[note].noteOff();
				}
				settings.sustainedNotes = new Array;
			}
		}
		
		function mouseActive (e) {		
			var coords = getPointerPosition(e);
		
			coords = getHexCoordsAt(coords);
			
			if (settings.activeHexObjects.length == 0) {
				settings.activeHexObjects[0] = new ActiveHex(coords);
				var cents = hexCoordsToCents(coords);
				settings.activeHexObjects[0].noteOn(cents);
				drawHex(coords, centsToColor(cents, true)); 			
			} else {
				if (!(coords.equals(settings.activeHexObjects[0].coords))) {
					settings.activeHexObjects[0].noteOff();
					drawHex(settings.activeHexObjects[0].coords, centsToColor(hexCoordsToCents(settings.activeHexObjects[0].coords, false))); 
					
					settings.activeHexObjects[0] = new ActiveHex(coords);
					var cents = hexCoordsToCents(coords);
					settings.activeHexObjects[0].noteOn(cents);
					drawHex(coords, centsToColor(cents, true));
				}
			}
		}
		
		function getPointerPosition(e) {
			var parentPosition = getPosition(e.currentTarget);
			var xPosition = e.clientX - parentPosition.x;
			var yPosition = e.clientY - parentPosition.y;
			return new Point(xPosition, yPosition);
		}
 
		function getPosition(element) {
			var xPosition = 0;
			var yPosition = 0;
      
			while (element) {
				xPosition += (element.offsetLeft - element.scrollLeft + element.clientLeft);
				yPosition += (element.offsetTop - element.scrollTop + element.clientTop);
				element = element.offsetParent;
			}
			return { x: xPosition, y: yPosition };
		}
		
		function handleTouch(e) {
			e.preventDefault();
			
			for (var i = 0; i < settings.activeHexObjects.length; i++) {
				settings.activeHexObjects[i].release = true; 
			}
			
			for (var i = 0; i < e.targetTouches.length; i++) {
				var coords = getHexCoordsAt(new Point(e.targetTouches[i].pageX - settings.canvas.offsetLeft, e.targetTouches[i].pageY - settings.canvas.offsetTop));
				var found = false;
				
				for (var j = 0; j < settings.activeHexObjects.length; j++) {
					if (coords.equals(settings.activeHexObjects[j].coords)) {
						settings.activeHexObjects[j].release = false;
						found = true;
						
					}
				}
				if (!(found)) {
					var newHex = new ActiveHex(coords);
					var cents = hexCoordsToCents(coords);
					newHex.noteOn(cents);
					var c = centsToColor(cents, true);
					drawHex(coords, c);
					settings.activeHexObjects.push(newHex);
				}
			}
			
			for (var i = settings.activeHexObjects.length - 1; i >= 0; i--) {
				if (settings.activeHexObjects[i].release) {
					settings.activeHexObjects[i].noteOff();
					var coords = settings.activeHexObjects[i].coords;
					var c = centsToColor(hexCoordsToCents(coords), false);
					drawHex(coords, c);
					settings.activeHexObjects.splice(i, 1);
				}
			}
		}
		
		function drawGrid() {
			var max = (settings.centerpoint.x > settings.centerpoint.y) ? settings.centerpoint.x / settings.hexSize : settings.centerpoint.y / settings.hexSize;
			max = Math.floor(max);
			for (var r = -max; r < max; r++) {
				for (var ur = -max; ur < max; ur++) {
					var coords = new Point(r, ur);
					var c = centsToColor(hexCoordsToCents(coords), false);
					drawHex(coords, c);
				}
			}
		}
		
		function hexCoordsToScreen(hex) { /* Point */
			var screenX = settings.centerpoint.x + hex.x * settings.hexWidth + hex.y * settings.hexWidth / 2;
			var screenY = settings.centerpoint.y + hex.y * settings.hexVert;
			return (new Point(screenX, screenY));
		}
		
		function drawHex(p, c) { /* Point, color */
			
			var hexCenter = hexCoordsToScreen(p);
			
			// Calculate hex vertices
			
			var x = new Array;
			var y = new Array;
			for (var i = 0; i < 6; i++) {
				var angle = 2 * Math.PI / 6 * (i + 0.5);
				x[i] = hexCenter.x + settings.hexSize * Math.cos(angle);
				y[i] = hexCenter.y + settings.hexSize * Math.sin(angle);
			}
			
			// Draw filled hex
			
			settings.context.beginPath();
			settings.context.moveTo(x[0], y[0]);
			for (var i = 1; i < 6; i++) {
				settings.context.lineTo(x[i], y[i]);
			}
			settings.context.closePath();
			settings.context.fillStyle = c;
			settings.context.fill();
			
			// Save context and create a hex shaped clip
			
			settings.context.save();
			settings.context.beginPath();
			settings.context.moveTo(x[0], y[0]);
			for (var i = 1; i < 6; i++) {
				settings.context.lineTo(x[i], y[i]);
			}
			settings.context.closePath();
			settings.context.clip();
			
			// Calculate hex vertices outside clipped path
			
			var x2 = new Array;
			var y2 = new Array;
			for (var i = 0; i < 6; i++) {
				var angle = 2 * Math.PI / 6 * (i + 0.5);
				x2[i] = hexCenter.x + (parseFloat(settings.hexSize) + 3) * Math.cos(angle);
				y2[i] = hexCenter.y + (parseFloat(settings.hexSize) + 3) * Math.sin(angle);
			}
			
			// Draw shadowed stroke outside clip to create pseudo-3d effect 
			
			settings.context.beginPath();
			settings.context.moveTo(x2[0], y2[0]);
			for (var i = 1; i < 6; i++) {
				settings.context.lineTo(x2[i], y2[i]);
			}
			settings.context.closePath();
			settings.context.strokeStyle = 'black';
			settings.context.lineWidth = 5;
			settings.context.shadowBlur = 15;
			settings.context.shadowColor = 'black';
			settings.context.shadowOffsetX = 0;
			settings.context.shadowOffsetY = 0;
			settings.context.stroke();
			settings.context.restore();
			
			// Add a clean stroke around hex
			
			settings.context.beginPath();
			settings.context.moveTo(x[0], y[0]);
			for (var i = 1; i < 6; i++) {
				settings.context.lineTo(x[i], y[i]);
			}
			settings.context.closePath();
			settings.context.lineWidth = 2;
			settings.context.lineJoin = 'round';
			settings.context.strokeStyle = 'black';
			settings.context.stroke();
			
			// Add note name and equivalence interval multiple
			
			settings.context.save();
			settings.context.translate(hexCenter.x, hexCenter.y);
			settings.context.rotate(-settings.rotation);
			// hexcoords = p and screenCoords = hexCenter
	
			settings.context.fillStyle = "black";
			settings.context.font = "24pt Arial";
			settings.context.textAlign = "center";
			settings.context.textBaseline = "middle";
			
			var note = p.x * settings.rSteps + p.y * settings.urSteps;
			var equivSteps = settings.enum ? parseInt(settings.equivSteps) : settings.scale.length;
			var equivMultiple = Math.floor(note / equivSteps);
			var reducedNote = note % equivSteps;
			if (reducedNote < 0) {
				reducedNote = equivSteps + reducedNote;
			}
			
			if(!settings.no_labels)
			{
				var name = settings.enum ? "" + reducedNote : settings.names[reducedNote];
				if (name) {
					settings.context.save();
					var scaleFactor = name.length > 3 ? 3 / name.length : 1;
					scaleFactor *= settings.hexSize / 50;
					settings.context.scale(scaleFactor, scaleFactor);
					settings.context.fillText(name, 0, 0);
					settings.context.restore();
				}
				
				var scaleFactor = settings.hexSize / 50;
				settings.context.scale(scaleFactor, scaleFactor);
				settings.context.translate(10, -25);
				settings.context.fillStyle = "white";
				settings.context.font = "12pt Arial";
				settings.context.textAlign = "center";
				settings.context.textBaseline = "middle";
				settings.context.fillText(equivMultiple, 0, 0);
			}
			
			settings.context.restore();
		}
		
		function centsToColor(cents, pressed) {
			//console.log(global_pressed_interval);
			is12=false;
			if(settings.scale.length==12)
			{
				is12=true;
			}
			if(settings.piano_colors && is12==true)
			//if(0)
			{
				var r=0;
				var g=0;
				var b=0;
				var light=255;
				var dark=100;
				var down_color = 90;
				if(global_pressed_interval == 0)
				{
					//A
					r = light;
					g = light;
					b = light;
				}
				else if(global_pressed_interval == 1){ r=dark; g=dark; b=dark; }//Bb
				else if(global_pressed_interval == 2){ r=light; g=light; b=light; }//B
				else if(global_pressed_interval == 3){ r=light; g=light; b=light; }//C
				else if(global_pressed_interval == 4){ r=dark; g=dark; b=dark; }//C#
				else if(global_pressed_interval == 5){ r=light; g=light; b=light; }//D
				else if(global_pressed_interval == 6){ r=dark; g=dark; b=dark; }//Eb
				else if(global_pressed_interval == 7){ r=light; g=light; b=light; }//E
				else if(global_pressed_interval == 8){ r=light; g=light; b=light; }//F
				else if(global_pressed_interval == 9){ r=dark; g=dark; b=dark; }//F#
				else if(global_pressed_interval == 10){ r=light; g=light; b=light; }//G
				else if(global_pressed_interval == 11){ r=dark; g=dark; b=dark; }//Ab

				if(pressed)
				{
					r-=90;
					g-=90;
				}
				return rgb(r,g,b);


			}
			var h = 2/3; // blue
			var reduced = (cents / 1200) % 1;
			if (reduced < 0) reduced += 1;
			h = (reduced + h) % 1;
			var v = (pressed) ? 0.5 : 1;
			return HSVtoRGB(h, 0.7, v);
		}
		
		function roundTowardZero(val) {
			if (val < 0) {
				return Math.ceil(val);
			}
    		return Math.floor(val);
		}
		
		function hexCoordsToCents(coords) {
			var distance = coords.x * settings.rSteps + coords.y * settings.urSteps;
			var octs = roundTowardZero(distance / settings.scale.length);
			var reducedSteps = distance % settings.scale.length;
			if (reducedSteps < 0) {
				reducedSteps += settings.scale.length;
				octs -= 1;
			}
			var cents = octs * settings.equivInterval + settings.scale[reducedSteps];
			global_pressed_interval = reducedSteps;
			return cents;
		}
		
		function getHexCoordsAt(coords) {
			coords = applyMatrixToPoint(settings.rotationMatrix, coords);
			var x = coords.x - settings.centerpoint.x;
			var y = coords.y - settings.centerpoint.y;

			var q = (x * Math.sqrt(3)/3 - y / 3) / settings.hexSize;
			var r = y * 2/3 / settings.hexSize;
			
			q = Math.round(q);
			r = Math.round(r);
			
			var guess = hexCoordsToScreen(new Point(q, r));
			
			// This gets an approximation; now check neighbours for minimum distance
			
			var minimum = 100000;
			var closestHex = new Point(q, r);
			for (var qOffset = -1; qOffset < 2; qOffset++) {
				for (var rOffset = -1; rOffset < 2; rOffset++) {
					var neighbour = new Point(q + qOffset, r + rOffset);
					var diff = hexCoordsToScreen(neighbour).minus(coords);
					var distance = diff.x * diff.x + diff.y * diff.y;
					if (distance < minimum) {
						minimum = distance;
						closestHex = neighbour;
					}
				}
			}
			
			return(closestHex);  
		}
		
		function rgb(r, g, b) {
			return "rgb("+r+","+g+","+b+")";
		}
		
		function HSVtoRGB(h, s, v) {
			var r, g, b, i, f, p, q, t;
			i = Math.floor(h * 6);
			f = h * 6 - i;
			p = v * (1 - s);
			q = v * (1 - f * s);
			t = v * (1 - (1 - f) * s);
			switch (i % 6) {
				case 0: r = v, g = t, b = p; break;
				case 1: r = q, g = v, b = p; break;
				case 2: r = p, g = v, b = t; break;
				case 3: r = p, g = q, b = v; break;
				case 4: r = t, g = p, b = v; break;
				case 5: r = v, g = p, b = q; break;
			}
			return rgb(Math.floor(r * 255), Math.floor(g * 255), Math.floor(b * 255));
		}

		function ActiveHex(coords) {
			this.coords = coords;
			this.release = false;
			this.freq = 440;
		}
		
		ActiveHex.prototype.noteOn = function(cents) {
			var freq = settings.fundamental * Math.pow(2, cents / 1200);
			var source = settings.audioContext.createBufferSource(); // creates a sound source
			// Choose sample
			var sampleFreq = 110;
			var sampleNumber = 0;
			if (freq > 155) {
				if (freq > 311) {
					if (freq > 622) {
						sampleFreq = 880; sampleNumber = 3;
					} else {
						sampleFreq = 440; sampleNumber = 2;
					}
				} else {
					sampleFreq = 220; sampleNumber = 1;
				}				
			}
			
			if (!(settings.sampleBuffer[sampleNumber])) return; // Sample not yet loaded
			
			source.buffer = settings.sampleBuffer[sampleNumber];     // tell the source which sound to play
			source.playbackRate.value = freq / sampleFreq;
			// Create a gain node.
			var gainNode = settings.audioContext.createGain();
			// Connect the source to the gain node.
			source.connect(gainNode);
			// Connect the gain node to the destination.
			gainNode.connect(settings.audioContext.destination);
			source.connect(gainNode);       // connect the source to the context's destination (the speakers)
			gainNode.gain.value = 0.3;
			source.start(0);                           // play the source now
            this.source = source;
			this.gainNode = gainNode;
		}
		
		ActiveHex.prototype.noteOff = function() {
			if (settings.sustain) {
				settings.sustainedNotes.push(this);
			} else {
			var fadeout = settings.audioContext.currentTime + settings.sampleFadeout;
				if (this.gainNode) this.gainNode.gain.setTargetAtTime(0, settings.audioContext.currentTime, settings.sampleFadeout);
				if (this.source) this.source.stop(fadeout + 4); // This is a terrible fudge. Please forgive me - it's late, I'm tired, I have a deadline, I've got other shit to do

			}
		}
		
window.addEventListener('load', init, false);

function init() {
  try {
    // Fix up for prefixing
    window.AudioContext = window.AudioContext||window.webkitAudioContext;
    settings.audioContext = new AudioContext();
  }
  catch(e) {
    alert('Web Audio API is not supported in this browser');
  }
}
	
	function loadSample(name, iteration) {
		// It seems audioContext doesn't cope with simultaneous decodeAudioData calls ):
		
		var sampleFreqs = ["110", "220", "440", "880"];
		//for (var i = 0; i < 4; ++i) {
			var request = new XMLHttpRequest();
			var url = 'sounds/' + name + sampleFreqs[iteration] + '.mp3';
			//console.log(iteration);
			request.open('GET', url, true);
			request.responseType = 'arraybuffer';

			// Decode asynchronously
			request.onload = function() {
				settings.audioContext.decodeAudioData(request.response, function(buffer) {
				settings.sampleBuffer[iteration] = buffer;
				if (iteration < 3) loadSample(name, iteration + 1);
				}, onLoadError);
			}
			request.send();
		//}
	}
	
function onLoadError(e) {
	alert("Couldn't load sample");
}



function tempAlert(msg,duration)
{
	 var el = document.createElement("div");
	 el.setAttribute("style","position:absolute;top:40%;left:20%;background-color:white; font-size:25px;");
	 el.innerHTML = msg;
	 setTimeout(function(){
	  el.parentNode.removeChild(el);
	 },duration);
	 document.body.appendChild(el);
}
	
	</script>

</body></html>